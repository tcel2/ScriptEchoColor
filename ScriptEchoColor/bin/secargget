#!/bin/bash
# Copyright (C) 2004-2012 by Henrique Abdalla
#
# This file is part of ScriptEchoColor.
#
# ScriptEchoColor simplifies Linux terminal text colorizing, formatting 
# and several steps of script coding.
#
# ScriptEchoColor is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# ScriptEchoColor is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with ScriptEchoColor. If not, see <http://www.gnu.org/licenses/>.
#
# Homepage: http://scriptechocolor.sourceforge.net/
# Project Homepage: https://sourceforge.net/projects/scriptechocolor/


# ScriptEchoColor uses these argument files, so don't call it here (reason: lockfile)!!!
 
strFile="$1"
strVar="$2"
strOpt="$3"
nIdenticalVarIDIndex=$(($3)) #@@@ used to allow to get values of a repeated name variables
 
if [[ "$strOpt" == "-q" ]]; then
  bOptQuiet=true
else
  bOptQuiet=false
fi

if [[ $strFile == "" || $strVar == "" ]]; then
    echo -e "$0: PROBLEM: arguments: file variable <-q(quiet no error messages)>\a" >/dev/stderr
    exit 1
fi

if [[ ! -f $strFile ]]; then
    if ! $bOptQuiet; then
      echo -e "$0: PROBLEM: invalid argument file '$strFile'\a" >/dev/stderr
    fi
    exit 1
fi

source "$HOME/.ScriptEchoColor/setup.cfg"

strLock=`$SECinstallPath/bin/seclockfile $strFile`;nRet=$?
if(($nRet!=0));then exit $nRet; fi
 
FUNCunlockExit(){
  rm -f "$strLock"
  exit $1
}
 
if [[ $nIdenticalVarIDIndex < 1 ]]; then 
    nIdenticalVarIDIndex=1
fi

strCompare=$strVar"("

strVarLine=`grep "$strCompare\(.*\)" "$strFile" -x |tail -n "+$nIdenticalVarIDIndex" |head -n 1` # lines are numbered n:...
if [[ "$strVarLine" != "" ]]; then
    str=`expr "$strVarLine" : ".*$strCompare"'\(.*\))'`
    echo "$str"
    FUNCunlockExit 0
fi

#not found!
if ! $bOptQuiet; then
  echo -e "$0: PROBLEM: variable '$strVar' not found at file '$strFile'\a" >/dev/stderr
fi

FUNCunlockExit 0 #2
  
